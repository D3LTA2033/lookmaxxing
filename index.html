<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Look Maxxer — Advanced AI Face Rating</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#8b5cf6; --muted:#9aa4b2; --glass: rgba(255,255,255,0.04);
      --radius:14px; --fw-700:700; --fw-600:600;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#071025 70%); color:#e6eef8; -webkit-font-smoothing:antialiased;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }

    .wrapper{width:100%; max-width:1100px}
    header{display:flex; align-items:center; gap:16px; margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021025}
    h1{margin:0;font-size:20px}
    p.lead{color:var(--muted); margin:4px 0 0;font-size:13px}

    .grid{display:grid; grid-template-columns: 1fr 440px; gap:24px}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }

    /* Card */
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:18px; box-shadow:0 6px 24px rgba(4,8,18,0.6)}

    /* Left: camera / upload */
    .capture-area{display:flex; flex-direction:column; gap:12px}
    .viewer{background:var(--card); border-radius:12px; height:420px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative}
    video, canvas.img-preview, canvas.landmarks{width:100%; height:100%; object-fit:cover; display:block; position:absolute; left:0; top:0}
    canvas.landmarks{pointer-events:none; z-index:2;}
    canvas.img-preview{position:relative; z-index:1;}
    .controls{display:flex; gap:8px; margin-top:10px}
    .btn{background:var(--glass); padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); cursor:pointer; color:inherit; font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#06b6d4); color:#021025}
    input[type=file]{display:none}

    .hint{font-size:13px;color:var(--muted)}

    /* Right: results */
    .results{display:flex; flex-direction:column; gap:12px}
    .score-big{font-size:52px; font-weight:700; line-height:1}
    .meter{height:12px;background:rgba(255,255,255,0.06); border-radius:8px; overflow:hidden}
    .meter > i{display:block;height:100%; background:linear-gradient(90deg,#10b981,var(--accent)); width:0%}
    .attr-list{display:grid; grid-template-columns:1fr 1fr; gap:8px}

    .attr{background:rgba(255,255,255,0.02); padding:10px; border-radius:10px}
    .attr .name{font-size:13px;color:var(--muted)}
    .attr .val{font-weight:700}

    .tips{font-size:13px; color:var(--muted)}

    footer.small{font-size:12px;color:var(--muted); margin-top:10px}

    /* processing overlay */
    .overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(2,6,23,0.5), rgba(2,6,23,0.6)); backdrop-filter: blur(4px); color: #eaf6ff; font-weight:700; font-size:14px; z-index:4}

    .spinner{width:40px;height:40px;border-radius:50%;border:4px solid rgba(255,255,255,0.06); border-top-color:var(--accent); animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .small-muted{color:var(--muted); font-size:12px}

    .face-attr-table {
      width:100%; border-spacing:0; margin-top:2px;
    }
    .face-attr-table td { font-size:13px; color:var(--muted);}
    .face-attr-table td.val { font-size:14px; color:#eaf6ff; font-weight:600;}

    .ai-badge {
      display:inline-block;
      background:#1e293b;
      color:#70e8d2;
      border-radius:6px;
      padding:2px 7px;
      font-size:12px;
      margin-left:6px;
      letter-spacing:0.5px;
      font-weight:600;
      vertical-align:middle;
    }
  </style>
  <!-- Load face-api.js from CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="logo">LM</div>
      <div>
        <h1>Look Maxxer — Advanced AI Face Rating <span class="ai-badge">AI</span></h1>
        <p class="lead">Take or upload a photo. AI-based face structure analysis and rating with facial landmarks overlay, using free APIs and privacy-respecting edge inference.</p>
      </div>
    </header>

    <div class="grid">
      <section class="card capture-area">
        <div class="viewer" id="viewer" style="position:relative;">
          <video id="video" autoplay playsinline style="display:none;position:absolute;left:0;top:0"></video>
          <canvas id="canvas" class="img-preview"></canvas>
          <canvas id="landmarks" class="landmarks"></canvas>
          <div id="procOverlay" class="overlay" style="display:none;z-index:3">
            <div style="text-align:center">
              <div class="spinner"></div>
              <div style="margin-top:8px" id="procText">Analyzing face structure…</div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button id="startCam" class="btn">Open Camera</button>
          <button id="snap" class="btn primary" disabled>Capture</button>
          <label class="btn" for="file">Upload</label>
          <input id="file" type="file" accept="image/*">
          <button id="retake" class="btn" style="margin-left:auto;">Retake</button>
        </div>
        <div class="hint">Tip: use straight-on, well-lit selfies. All analysis is performed in-browser, private and secure.</div>
        <div class="small-muted">Face structure and beauty assessment is client-side using free open-source models.</div>
      </section>

      <aside class="card results">
        <div>
          <div style="display:flex; align-items:center; justify-content:space-between">
            <div>
              <div class="small-muted">Overall AI Score <span class="ai-badge">AI</span></div>
              <div class="score-big" id="score">—</div>
            </div>
            <div style="width:140px; text-align:right">
              <div class="small-muted">Confidence</div>
              <div id="confidence" style="font-weight:700">—</div>
            </div>
          </div>
          <div style="margin-top:12px">
            <div class="meter"><i id="meterFill"></i></div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small-muted">Face Structure Attributes</div>
          <div id="structuredAttrs" style="margin-top:3px;">
            <table class="face-attr-table">
              <tr><td>Symmetry</td><td class="val" id="symmetry">—</td></tr>
              <tr><td>Golden Ratio</td><td class="val" id="golden">—</td></tr>
              <tr><td>Jawline Quality</td><td class="val" id="jaw">—</td></tr>
              <tr><td>Eye Ratio</td><td class="val" id="eyes">—</td></tr>
            </table>
          </div>
        </div>

        <div style="margin-top:6px">
          <div class="small-muted">Standard Image Attributes</div>
          <div class="attr-list" id="attrs">
            <div class="attr"><div class="name">Brightness</div><div class="val" id="brightness">—</div></div>
            <div class="attr"><div class="name">Contrast</div><div class="val" id="contrast">—</div></div>
            <div class="attr"><div class="name">Sharpness</div><div class="val" id="sharpness">—</div></div>
            <div class="attr"><div class="name">Exposure</div><div class="val" id="exposure">—</div></div>
          </div>
        </div>

        <div>
          <div style="margin-top:10px" class="small-muted">AI Tips</div>
          <div class="tips" id="tips">Take or upload a clear photo to see AI-based analysis and facial lines.</div>
        </div>

        <footer class="small">Powered by free, open-source face-api.js models running locally. No photo leaves your browser. <br>For best accuracy use high-res, front-facing images.</footer>
      </aside>
    </div>
  </div>

  <script>
    // ========== Elements ==========
    const startCam = document.getElementById('startCam');
    const snap = document.getElementById('snap');
    const fileInput = document.getElementById('file');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const landmarksCanvas = document.getElementById('landmarks');
    const ctx = canvas.getContext('2d');
    const lctx = landmarksCanvas.getContext('2d');
    const procOverlay = document.getElementById('procOverlay');
    const procText = document.getElementById('procText');

    const scoreEl = document.getElementById('score');
    const confEl = document.getElementById('confidence');
    const meterFill = document.getElementById('meterFill');
    const brightnessEl = document.getElementById('brightness');
    const contrastEl = document.getElementById('contrast');
    const sharpnessEl = document.getElementById('sharpness');
    const exposureEl = document.getElementById('exposure');
    const tipsEl = document.getElementById('tips');
    const symmetryEl = document.getElementById('symmetry');
    const goldenEl = document.getElementById('golden');
    const jawEl = document.getElementById('jaw');
    const eyeEl = document.getElementById('eyes');

    let stream = null;
    let modelsLoaded = false;

    // ========== UI Helpers ==========

    function setProcessing(on, text='Analyzing face...') {
      procOverlay.style.display = on ? 'flex' : 'none';
      procText.textContent = text || 'Analyzing face...';
    }

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    function clearLandmarks() {
      lctx.clearRect(0,0,landmarksCanvas.width,landmarksCanvas.height);
    }

    function resetViewer() {
      stopCamera();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      clearLandmarks();
      canvas.style.display='none'; 
      landmarksCanvas.style.display='none';
      video.style.display='none'; 
      scoreEl.textContent='—';
      confEl.textContent='—';
      meterFill.style.width='0%';
      brightnessEl.textContent='—';
      contrastEl.textContent='—';
      sharpnessEl.textContent='—';
      exposureEl.textContent='—';
      symmetryEl.textContent='—';
      goldenEl.textContent='—';
      jawEl.textContent='—';
      eyeEl.textContent='—';
      tipsEl.textContent='Take or upload a clear photo to see AI-based analysis and facial lines.';
    }

    // ========== Camera Controls ==========

    async function openCamera(){
      if (stream) return;
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:'user', width:{ideal:1280}, height:{ideal:720}}, audio:false
        });
        video.srcObject = stream;
        video.style.display = 'block';
        canvas.style.display = 'none';
        landmarksCanvas.style.display = 'none';
        snap.disabled = false;
      }catch(err){ alert('Camera access denied or not available. Use upload instead.'); }
    }

    function stopCamera(){ 
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.style.display='none'; } 
    }

    startCam.addEventListener('click', async ()=>{ await openCamera(); });
    snap.addEventListener('click', ()=>{ captureFrame(); });
    document.getElementById('retake').addEventListener('click', ()=>{ resetViewer(); });

    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if (!f) return; const url = URL.createObjectURL(f); loadImage(url);
    });

    // ========== Image Utilities ==========

    function captureFrame(){
      const w = video.videoWidth || 1280, h = video.videoHeight || 720;
      canvas.width = w; canvas.height = h;
      landmarksCanvas.width = w; landmarksCanvas.height = h;
      ctx.drawImage(video,0,0,w,h);
      canvas.style.display='block'; 
      landmarksCanvas.style.display='block';
      video.style.display='none'; 
      runFaceAnalysis();
    }

    function loadImage(src){
      const img = new Image(); img.crossOrigin='anonymous'; img.onload = ()=>{
        const maxW = 1280; const scale = Math.min(1, maxW / img.width);
        const w = img.width * scale, h = img.height * scale;
        canvas.width = w; canvas.height = h;
        landmarksCanvas.width = w; landmarksCanvas.height = h;
        ctx.drawImage(img,0,0,w,h);
        canvas.style.display='block';
        landmarksCanvas.style.display = 'block';
        video.style.display='none';
        // Automatically run face analysis as soon as the image is loaded
        runFaceAnalysis();
      };
      img.onerror = ()=>{ alert('Failed to load image.'); }
      img.src = src;
    }

    // ========== Standard Image Quality Analysis (as before) ==========

    function analyzeStandardImageQuality(){
      const w = canvas.width, h = canvas.height;
      const imgd = ctx.getImageData(0,0,w,h);
      const data = imgd.data;
      // compute brightness (mean), contrast (stddev), sharpness (simple gradient variance), exposure bias
      let sum=0, sumSq=0;
      let gray = new Float32Array(w*h);
      for(let i=0, p=0; i<data.length; i+=4, p++){
        const r=data[i], g=data[i+1], b=data[i+2];
        const lum = (0.299*r + 0.587*g + 0.114*b);
        gray[p]=lum; sum+=lum; sumSq+=lum*lum;
      }
      const n = w*h;
      const mean = sum / n;
      const variance = (sumSq / n) - (mean*mean);
      const stddev = Math.sqrt(Math.max(0, variance));

      // sharpness: approximate via gradient magnitude variance
      let gradSum=0, gradSq=0;
      for(let y=1;y<h-1;y++){
        for(let x=1;x<w-1;x++){
          const i = y*w + x;
          const gx = gray[i+1] - gray[i-1];
          const gy = gray[i+w] - gray[i-w];
          const mag = Math.abs(gx)+Math.abs(gy);
          gradSum += mag; gradSq += mag*mag;
        }
      }
      const mcount = (w-2)*(h-2);
      const gmean = gradSum / mcount;
      const gvar = (gradSq / mcount) - (gmean*gmean);
      const gstd = Math.sqrt(Math.max(0,gvar));

      // exposure bias: distance from mid-gray (128)
      const exposureBias = Math.abs(mean - 128);

      // normalize metrics to 0..1 heuristically
      const brightnessScore = clamp((mean/255),0,1);
      const contrastScore = clamp(stddev/70,0,1); // 70 ish -> strong
      const sharpnessScore = clamp(gmean/30,0,1);
      const exposureScore = clamp(1 - (exposureBias/80),0,1);

      // update UI
      brightnessEl.textContent = Math.round(brightnessScore*100)+'%';
      contrastEl.textContent = Math.round(contrastScore*100)+'%';
      sharpnessEl.textContent = Math.round(sharpnessScore*100)+'%';
      exposureEl.textContent = Math.round(exposureScore*100)+'%';

      return {brightnessScore, contrastScore, sharpnessScore, exposureScore};
    }

    // ========== Face-API MODEL LOADING ==========

    async function loadModelsIfNeeded() {
      if (modelsLoaded) return;
      setProcessing(true, 'Loading AI models...');
      await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models');
      await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models');
      modelsLoaded = true;
      setProcessing(false);
    }

    // ========== Advanced Face Analysis ==========

    async function runFaceAnalysis(){
      try{
        setProcessing(true,'Detecting face...');
        await loadModelsIfNeeded();

        // Prepare cropped input for face-api
        const input = canvas;
        const displaySize = { width: canvas.width, height: canvas.height };
        faceapi.matchDimensions(landmarksCanvas, displaySize);

        // Detect the face and landmarks
        const detections = await faceapi.detectSingleFace(input, new faceapi.TinyFaceDetectorOptions())
          .withFaceLandmarks(true);
        clearLandmarks();

        if(!detections || !detections.landmarks || !detections.detection){
          setProcessing(false);
          // clear scores and show error
          scoreEl.textContent='—';
          confEl.textContent='—';
          meterFill.style.width='0%';
          symmetryEl.textContent='—';
          goldenEl.textContent='—';
          jawEl.textContent='—';
          eyeEl.textContent='—';
          tipsEl.textContent='No face clearly detected! Please retake or use a frontal, well-lit face photo.';
          return;
        }

        // Draw Landmarks (face structure)
        faceapi.draw.drawDetections(landmarksCanvas, faceapi.resizeResults(detections.detection, displaySize));
        faceapi.draw.drawFaceLandmarks(landmarksCanvas, faceapi.resizeResults(detections.landmarks, displaySize));

        // Advanced Structure Metrics
        const fs = computeFaceStructureScores(detections.landmarks);

        // Update advanced structure UI
        symmetryEl.textContent = (fs.symmetry*100).toFixed(1)+'%';
        goldenEl.textContent = (fs.goldenRatio*100).toFixed(1)+'%';
        jawEl.textContent = (fs.jawQuality*100).toFixed(1)+'%';
        eyeEl.textContent = (fs.eyeRatio*100).toFixed(1)+'%';

        // Update Standard Image Quality
        const q = analyzeStandardImageQuality();

        // AI-based "beauty" score: sym 35%, golden 20%, jaw 12%, eye 8%, std img (brightness, sharpness, etc) 25%
        const aiScore = clamp(
          (0.35*fs.symmetry) +
          (0.20*fs.goldenRatio) +
          (0.12*fs.jawQuality) +
          (0.08*fs.eyeRatio) +
          (0.25*((q.brightnessScore+q.sharpnessScore+q.contrastScore+q.exposureScore)/4))
        , 0, 1);

        scoreEl.textContent = Math.round(aiScore*100);
        meterFill.style.width = Math.round(aiScore*100)+'%';
        // Confidence: face detection confidence
        confEl.textContent = Math.round(100*clamp(detections.detection.score,0,1)) + '%';

        // Compose AI Tips
        let tips = [];
        if(fs.symmetry < 0.5) tips.push('Try facing the camera directly, keep expression neutral for increased symmetry.');
        if(fs.goldenRatio < 0.55) tips.push('Adjust camera angle: a more "golden ratio" face angle may enhance your look.');
        if(fs.jawQuality < 0.5) tips.push('Better lighting or slight down-softer angle could define jawline more.');
        if(fs.eyeRatio < 0.5) tips.push('Open your eyes a little more, avoid squinting.');
        if(q.brightnessScore < 0.5) tips.push('Improve lighting for best results.');
        if(q.sharpnessScore < 0.5) tips.push('Increase camera sharpness or use steadier hands.');
        if (tips.length===0) tips.push('Excellent structure! For even better shots, try natural light and a relaxed expression.');
        tipsEl.textContent = tips.join(' ');

        setProcessing(false, '');
      }catch(e){
        setProcessing(false);
        scoreEl.textContent='—';
        confEl.textContent='—';
        meterFill.style.width='0%';
        symmetryEl.textContent='—';
        goldenEl.textContent='—';
        jawEl.textContent='—';
        eyeEl.textContent='—';
        tipsEl.textContent='Analysis failed: '+(e.message);
      }
    }

    // ========== Face Structure Utility Functions ==========

    // Return normalized symmetry, golden ratio, jawline quality, eye openness/ratio
    function computeFaceStructureScores(landmarks){
      // - Symmetry: average difference between corresponding left/right points
      // - Golden ratio: compare ratios of facial sections to phi
      // - Jawline: sharpness/width ratio of jaw contour points
      // - Eye: openness vertical/horizontal ratio

      // Standard symmetrical index landmarks (face-api 68)
      const pts = landmarks.positions;

      // Compute symmetry between left-side and right-side points
      let pairs = [
        [0,16],[1,15],[2,14],[3,13],[4,12],[5,11],[6,10],[7,9], // jaw
        [17,26], // brows
        [36,45],[39,42], // eyes
        [31,35],[32,34]  // nose wings
      ];
      let sumDist = 0, count=0;
      const midX = (pts[27].x+pts[28].x+pts[29].x+pts[30].x)/4; // between the brows is center line
      pairs.forEach(p=>{
        if(Array.isArray(p)){
          const l=pts[p[0]], r=pts[p[1]];
          sumDist += Math.abs((l.x-midX)-(midX-r.x));
          count++;
        }else {
          const l=pts[p], r=pts[33-p]; // e.g. 17/26
          sumDist += Math.abs((l.x-midX)-(midX-r.x));
          count++;
        }
      });
      const symmetry = 1 - clamp(sumDist/(count*40),0,1); // higher is better

      // Golden ratio: vertical ratios between chin, nose, brows, hairline (est.)
      // Face: top of forehead ~17, nose-base 33, chin 8
      const browY = (pts[19].y+pts[24].y)/2;
      const noseY = pts[33].y;
      const chinY = pts[8].y;
      const hairlineY = pts[17].y - (browY-pts[17].y); // estimate
      const total = chinY - hairlineY;
      const top = browY - hairlineY;
      const mid = noseY - browY;
      const bottom = chinY - noseY;
      // ratios: golden = 1.618...
      function goldenCheck(a,b){ 
        const phi = 1.618;
        return 1 - Math.abs((a/b)-phi)/(phi); // 1 = perfect
      }
      const r1 = goldenCheck(total,top+mid+bottom);
      const r2 = goldenCheck(top+mid,bottom);
      const r3 = goldenCheck(top,mid);
      const goldenRatio = clamp((r1+r2+r3)/3,0,1);

      // Jawline quality
      // Ratio between width of jaw and height, and jaw "sharpness"
      const L = pts[4], R = pts[12], chin = pts[8];
      const jawWidth = Math.abs(R.x-L.x);
      const faceHeight = Math.abs(chin.y-browY);
      let jawSharpness = (Math.abs(pts[6].y-chin.y)+Math.abs(pts[10].y-chin.y))/2;
      jawSharpness = 1 - clamp(jawSharpness/faceHeight, 0, 1);
      let jawQ = clamp(jawWidth/faceHeight*0.45 + jawSharpness*0.55, 0, 1);

      // Eye ratio: eye-openess
      function eyeOpenness(lidx){
        // top-mid, bottom-mid, left-corner, right-corner
        const top = pts[lidx+1], bot=pts[lidx+5], left=pts[lidx], right=pts[lidx+3];
        const v = Math.abs(top.y-bot.y);
        const h = Math.abs(right.x-left.x);
        return v/h;
      }
      const lEye = eyeOpenness(36); // left eye (from viewer perspective)
      const rEye = eyeOpenness(42);
      // typical ratio 0.25-0.3 is "wide open", <0.20 = squinty
      const eyeRatio = clamp(((lEye+rEye)/2-0.18)/0.12, 0, 1);

      return { symmetry, goldenRatio, jawQuality:jawQ, eyeRatio };
    }

    // ========== Demo image loader, as before ==========

    (function loadDemo(){
      const url = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/examples/examples/media/sample1.jpg';
      loadImage(url);
    })();

    // ========== Resize overlays on window resize (for images shown) ==========
    window.addEventListener('resize', function() {
      if(canvas.style.display !== 'none' && canvas.width && canvas.height) {
        landmarksCanvas.width = canvas.width;
        landmarksCanvas.height = canvas.height;
      }
    });

  </script>
</body>
</html>
